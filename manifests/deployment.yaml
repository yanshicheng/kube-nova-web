apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-nginx-config
  namespace: ikubeops
  labels:
    app: frontend
data:
  default.conf: |
    # Upstream definitions
    upstream portal_api {
    least_conn;
    server portal-api.ikubeops.svc.cluster.local:8810 max_fails=3 fail_timeout=30s;
    keepalive 32;
    }
    
    upstream manager_api {
      least_conn;
      server manager-api.ikubeops.svc.cluster.local:8811 max_fails=3 fail_timeout=30s;
      keepalive 32;
    }
    
      upstream workload_api {
      least_conn;
      server workload-api.ikubeops.svc.cluster.local:8812 max_fails=3 fail_timeout=30s;
      keepalive 32;
    }
    
      upstream console_api {
      least_conn;
      server console-api.ikubeops.svc.cluster.local:8818 max_fails=3 fail_timeout=30s;
      keepalive 32;
    }
    
    
    
    # Main server block
      server {
      listen 80;
      server_name _;
    
      # Root directory
      root /usr/share/nginx/html;
      index index.html;
    
      # Charset
      charset utf-8;
    
      # Security headers
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "no-referrer-when-downgrade" always;
      add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
      # Rate limiting
      limit_req zone=general burst=200 nodelay;
      limit_conn addr 20;
    
      # Health check endpoint
      location /health {
      access_log off;
      return 200 "healthy\n";
      add_header Content-Type text/plain;
      }
    
      # WebSocket proxy for console
      location /ws/v1/pod {
      proxy_pass http://console_api;
    
      # WebSocket specific headers
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    
      # Proxy headers
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
    
      # Timeouts for WebSocket
      proxy_connect_timeout 7d;
      proxy_send_timeout 7d;
      proxy_read_timeout 7d;
    
      # Buffering
      proxy_buffering off;
      proxy_request_buffering off;
    
      # Rate limiting for WebSocket
      limit_req zone=api burst=10 nodelay;
      }
    
      # WebSocket proxy for portal_api
      location /ws/v1/site-messages {
      proxy_pass http://portal_api;
    
      # WebSocket specific headers
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    
      # Proxy headers
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
    
      # Timeouts for WebSocket
      proxy_connect_timeout 7d;
      proxy_send_timeout 7d;
      proxy_read_timeout 7d;
    
      # Buffering
      proxy_buffering off;
      proxy_request_buffering off;
    
      # Rate limiting for WebSocket
      limit_req zone=api burst=10 nodelay;
      }
    
      # Portal API proxy
      location /api/portal {
      rewrite ^/api/portal/(.*) /portal/$1 break;
    
      proxy_pass http://portal_api;
    
      # Proxy headers
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
    
      # HTTP version
      proxy_http_version 1.1;
      proxy_set_header Connection "";
    
      # Timeouts
      proxy_connect_timeout 30s;
      proxy_send_timeout 30s;
      proxy_read_timeout 30s;
    
      # Buffering
      proxy_buffering on;
      proxy_buffer_size 4k;
      proxy_buffers 8 4k;
      proxy_busy_buffers_size 8k;
    
      # Error handling
      proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
      proxy_next_upstream_tries 2;
    
      # Rate limiting
      limit_req zone=api burst=20 nodelay;
      }
    
      # Manager API proxy
      location /api/manager {
      rewrite ^/api/manager/(.*) /manager/$1 break;
    
      proxy_pass http://manager_api;
    
      # Proxy headers
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
    
      # HTTP version
      proxy_http_version 1.1;
      proxy_set_header Connection "";
    
      # Timeouts
      proxy_connect_timeout 30s;
      proxy_send_timeout 30s;
      proxy_read_timeout 30s;
    
      # Buffering
      proxy_buffering on;
      proxy_buffer_size 4k;
      proxy_buffers 8 4k;
      proxy_busy_buffers_size 8k;
    
      # Error handling
      proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
      proxy_next_upstream_tries 2;
    
      # Rate limiting
      limit_req zone=api burst=20 nodelay;
      }
    
      # Workload API proxy
      location /api/workload {
      rewrite ^/api/workload/(.*) /workload/$1 break;
    
      proxy_pass http://workload_api;
    
      # Proxy headers
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
    
      # HTTP version
      proxy_http_version 1.1;
      proxy_set_header Connection "";
    
      # Timeouts
      proxy_connect_timeout 30s;
      proxy_send_timeout 30s;
      proxy_read_timeout 30s;
    
      # Buffering
      proxy_buffering on;
      proxy_buffer_size 4k;
      proxy_buffers 8 4k;
      proxy_busy_buffers_size 8k;
    
      # Error handling
      proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
      proxy_next_upstream_tries 2;
    
      # Rate limiting
      limit_req zone=api burst=20 nodelay;
      }
    
      # Console API proxy
      location /api/console {
      rewrite ^/api/console/(.*) /console/$1 break;
    
      proxy_pass http://console_api;
    
      # Proxy headers
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
    
      # HTTP version
      proxy_http_version 1.1;
      proxy_set_header Connection "";
    
      # Timeouts - longer for console operations
      proxy_connect_timeout 600s;
      proxy_send_timeout 600s;
      proxy_read_timeout 600s;
    
      # Buffering - disabled for streaming responses
      proxy_buffering off;
      proxy_request_buffering off;
    
      # Error handling
      proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
      proxy_next_upstream_tries 2;
    
      # Rate limiting
      limit_req zone=api burst=20 nodelay;
      }
    
      # Static assets - cache for 1 year
      location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot|otf)$ {
      expires 1y;
      add_header Cache-Control "public, immutable";
      access_log off;
    
      # CORS for fonts
      location ~* \.(woff|woff2|ttf|eot|otf)$ {
      add_header Access-Control-Allow-Origin "*";
      }
      }
    
      # JavaScript and CSS - cache for 1 year with revalidation
      location ~* \.(js|css)$ {
      expires 1y;
      add_header Cache-Control "public, must-revalidate";
      access_log off;
      }
    
      # HTML files - no cache
      location ~* \.html$ {
      expires -1;
      add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
      }
    
      # Favicon
      location = /favicon.ico {
      log_not_found off;
      access_log off;
      expires 1y;
      }
    
      # Robots
      location = /robots.txt {
      log_not_found off;
      access_log off;
      }
    
      # Deny access to hidden files
      location ~ /\. {
      deny all;
      access_log off;
      log_not_found off;
      }
    
      # Vue Router - SPA fallback
      location / {
      try_files $uri $uri/ /index.html;
    
      # Cache control for HTML
      add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    
      # Security headers
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      }
    
      # Error pages
      error_page 404 /index.html;
      error_page 500 502 503 504 /50x.html;
    
      location = /50x.html {
      root /usr/share/nginx/html;
      internal;
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kube-nova-web
  namespace: ikubeops
  labels:
    app: kube-nova-web
    tier: kube-nova-web
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: kube-nova-web
  template:
    metadata:
      labels:
        app: kube-nova-web
        tier: kube-nova-web
    spec:
      # Anti-affinity to spread pods across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - kube-nova-web
                topologyKey: kubernetes.io/hostname

      containers:
        - name: kube-nova-web
          image: registry.cn-hangzhou.aliyuncs.com/kube-nova/kube-nova-web:latest
          imagePullPolicy: Always

          ports:
            - containerPort: 80
              name: http
              protocol: TCP

          env:
            - name: TZ
              value: "Asia/Shanghai"
            - name: NGINX_WORKER_PROCESSES
              value: "auto"
            - name: NGINX_WORKER_CONNECTIONS
              value: "4096"

          # Volume mounts - ConfigMap enabled
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
            - name: cache
              mountPath: /var/cache/nginx
            - name: logs
              mountPath: /var/log/nginx
            - name: run
              mountPath: /var/run

          # Health checks
          livenessProbe:
            httpGet:
              path: /health
              port: 80
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health
              port: 80
              scheme: HTTP
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3

          # Startup probe for slow starting containers
          startupProbe:
            httpGet:
              path: /health
              port: 80
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 2
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 30

          # Resource limits and requests
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"

      volumes:
        - name: nginx-config
          configMap:
            name: frontend-nginx-config
            items:
              - key: nginx.conf
                path: nginx.conf
              - key: default.conf
                path: default.conf
        - name: cache
          emptyDir:
            sizeLimit: 1Gi
        - name: logs
          emptyDir:
            sizeLimit: 500Mi
        - name: run
          emptyDir:
            sizeLimit: 10Mi

      # DNS policy
      dnsPolicy: ClusterFirst

      # Restart policy
      restartPolicy: Always

      # Grace period for pod termination
      terminationGracePeriodSeconds: 30

---
# ClusterIP Service - for internal cluster access
apiVersion: v1
kind: Service
metadata:
  name: kube-nova-web
  namespace: ikubeops
  labels:
    app: kube-nova-web
    tier: kube-nova-web
spec:
  type: ClusterIP
  selector:
    app: kube-nova-web
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
  sessionAffinity: None

---
apiVersion: v1
kind: Service
metadata:
  name: kube-nova-web-nodeport
  namespace: ikubeops
  labels:
    app: kube-nova-web
    tier: kube-nova-web
    service-type: nodeport
spec:
  type: NodePort
  selector:
    app: kube-nova-web
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
      nodePort: 30282
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
